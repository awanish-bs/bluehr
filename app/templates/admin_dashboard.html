{% extends "base.html" %}

{% block content %}
  <h2>Admin Dashboard</h2>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="finance-tab" data-toggle="tab" href="#finance" role="tab" aria-controls="finance" aria-selected="true">Finance</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="hr-tab" data-toggle="tab" href="#hr" role="tab" aria-controls="hr" aria-selected="false">HR</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="employment-history-tab" data-toggle="tab" href="#employment-history" role="tab" aria-controls="employment-history" aria-selected="false">Employment History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="others-tab" data-toggle="tab" href="#others" role="tab" aria-controls="others" aria-selected="false">Others</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="admin-tab" data-toggle="tab" href="#admin" role="tab" aria-controls="admin" aria-selected="false">Admin</a>
    </li>
  </ul>

  <div class="tab-content mt-3" id="adminTabContent">
    <div class="tab-pane fade show active" id="finance" role="tabpanel" aria-labelledby="finance-tab">
      <!-- Employee Payslips Collapsible Section -->
      <div class="card mb-3">
        <div class="card-header bg-light font-weight-bold d-flex justify-content-between align-items-center" id="headingPayslips" style="cursor:pointer;" data-toggle="collapse" data-target="#collapsePayslips" aria-expanded="false" aria-controls="collapsePayslips">
          <span>Employee Payslips</span>
          <span class="collapse-icon" id="iconPayslips">&#9654;</span>
        </div>
        <div id="collapsePayslips" class="collapse" aria-labelledby="headingPayslips">
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if employee_payslips %}
              {% for employee, payslips in employee_payslips.items() %}
                <div class="mb-2">
                  <strong>{{ employee.first_name }} {{ employee.last_name }}</strong>
                  <ul class="list-group list-group-flush">
                    {% for payslip in payslips %}
                      <li class="list-group-item py-1 d-flex justify-content-between align-items-center">
                        <span>
                          <a href="{{ url_for('static', filename=payslip.file_path) }}" target="_blank">
                            Payslip - {{ payslip.upload_date.strftime('%Y-%m-%d') }}
                          </a>
                        </span>
                        <form method="post" action="{{ url_for('admin_delete_payslip', payslip_id=payslip.id) }}" style="display:inline;">
                          <button type="submit" class="btn btn-sm btn-danger ml-2">Delete</button>
                        </form>
                      </li>
                    {% else %}
                      <li class="list-group-item py-1 text-muted">No payslips found.</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            {% else %}
              <p>No employees or payslips found.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Upload Payslip Collapsible Section -->
      <div class="card">
        <div class="card-header bg-light font-weight-bold d-flex justify-content-between align-items-center" id="headingUpload" style="cursor:pointer;" data-toggle="collapse" data-target="#collapseUpload" aria-expanded="false" aria-controls="collapseUpload">
          <span>Upload Payslip</span>
          <span class="collapse-icon" id="iconUpload">&#9654;</span>
        </div>
        <div id="collapseUpload" class="collapse" aria-labelledby="headingUpload">
          <script>
            // Helper to toggle icon direction
            function toggleIcon(section, iconId) {
              var icon = document.getElementById(iconId);
              if (section.classList.contains('show')) {
                icon.innerHTML = '\u25BC'; // Down arrow
              } else {
                icon.innerHTML = '\u25B6'; // Right arrow
              }
            }
            document.addEventListener('DOMContentLoaded', function() {
              var payslipsSection = document.getElementById('collapsePayslips');
              var payslipsIcon = document.getElementById('iconPayslips');
              var uploadSection = document.getElementById('collapseUpload');
              var uploadIcon = document.getElementById('iconUpload');
              if (payslipsSection && payslipsIcon) {
                payslipsSection.addEventListener('show.bs.collapse', function() { toggleIcon(payslipsSection, 'iconPayslips'); });
                payslipsSection.addEventListener('hide.bs.collapse', function() { toggleIcon(payslipsSection, 'iconPayslips'); });
                toggleIcon(payslipsSection, 'iconPayslips');
              }
              if (uploadSection && uploadIcon) {
                uploadSection.addEventListener('show.bs.collapse', function() { toggleIcon(uploadSection, 'iconUpload'); });
                uploadSection.addEventListener('hide.bs.collapse', function() { toggleIcon(uploadSection, 'iconUpload'); });
                toggleIcon(uploadSection, 'iconUpload');
              }
            });
          </script>
          <div class="card-body">
            <form method="post" action="{{ url_for('upload_payslip') }}" enctype="multipart/form-data">
              <div class="form-group">
                <label for="employee_id">Employee</label>
                <select class="form-control" id="employee_id" name="employee_id" required>
                  <option value="" disabled selected>Select an employee</option>
                  {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="month_year">Month and Year</label>
                <input type="month" class="form-control" id="month_year" name="month_year" required>
              </div>
              <div class="form-group">
                <label for="payslip">Payslip File</label>
                <input type="file" class="form-control-file" id="payslip" name="payslip" required>
              </div>
              <button type="submit" class="btn btn-primary">Upload</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="hr" role="tabpanel" aria-labelledby="hr-tab">
      <div class="card">
        <div class="card-header bg-light font-weight-bold">
          Onboarding/Offboarding
        </div>
        <div class="card-body">
          <p>WIP</p>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="employment-history" role="tabpanel" aria-labelledby="employment-history-tab">
      <div class="card">
        <div class="card-header bg-light font-weight-bold">
          <h5 class="mb-0">Employee Employment History</h5>
        </div>
        <div class="card-body">
          <p class="text-muted">View employment history submitted by employees.</p>
          
          <div id="adminEmploymentHistoryList">
            <div class="text-center py-3">
              <span class="spinner-border spinner-border-sm" role="status"></span>
              Loading employment history...
            </div>
          </div>
        </div>
      </div>
      
      <script>
        // Load employment history when tab is clicked
        document.getElementById('employment-history-tab').addEventListener('click', function() {
          loadAdminEmploymentHistory();
        });
        
        function loadAdminEmploymentHistory() {
          fetch('/admin/employment_history')
            .then(response => response.json())
            .then(data => {
              const container = document.getElementById('adminEmploymentHistoryList');
              
              if (data.length === 0) {
                container.innerHTML = '<p class="text-muted">No employees found.</p>';
                return;
              }
              
              let html = '<div class="accordion" id="employmentAccordion">';
              
              data.forEach(function(employee, index) {
                const hasHistory = employee.employment_history && employee.employment_history.length > 0;
                const historyCount = hasHistory ? employee.employment_history.length : 0;
                
                html += `
                  <div class="card mb-2">
                    <div class="card-header p-2" id="heading${index}">
                      <h6 class="mb-0 d-flex justify-content-between align-items-center">
                        <button class="btn btn-link text-left collapsed" type="button" data-toggle="collapse" data-target="#collapse${index}" aria-expanded="false">
                          <strong>${employee.first_name} ${employee.last_name}</strong> 
                          <span class="text-muted ml-2">(${employee.employee_id})</span>
                        </button>
                        <span class="badge badge-${hasHistory ? 'primary' : 'secondary'}">${historyCount} record${historyCount !== 1 ? 's' : ''}</span>
                      </h6>
                    </div>
                    <div id="collapse${index}" class="collapse" aria-labelledby="heading${index}" data-parent="#employmentAccordion">
                      <div class="card-body">
                `;
                
                if (hasHistory) {
                  html += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                  html += '<thead class="thead-light"><tr><th>Company</th><th>Designation</th><th>Start Date</th><th>End Date</th></tr></thead><tbody>';
                  
                  employee.employment_history.forEach(function(job) {
                    const endDate = job.end_date ? job.end_date : '<span class="badge badge-success">Present</span>';
                    html += `<tr><td>${job.company_name}</td><td>${job.designation}</td><td>${job.start_date}</td><td>${endDate}</td></tr>`;
                  });
                  
                  html += '</tbody></table></div>';
                } else {
                  html += '<p class="text-muted mb-0">No employment history submitted by this employee.</p>';
                }
                
                html += '</div></div></div>';
              });
              
              html += '</div>';
              container.innerHTML = html;
            })
            .catch(error => {
              console.error('Error loading employment history:', error);
              document.getElementById('adminEmploymentHistoryList').innerHTML = '<p class="text-danger">Error loading employment history. Please try again.</p>';
            });
        }
      </script>
    </div>
    <div class="tab-pane fade" id="others" role="tabpanel" aria-labelledby="others-tab">
      <p>WIP</p>
    </div>
    <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All Users</h3>
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteAllUsersModal">
          Delete All Users
        </button>
      </div>

      <!-- Delete All Users Modal -->
      <div class="modal fade" id="deleteAllUsersModal" tabindex="-1" role="dialog" aria-labelledby="deleteAllUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteAllUsersModalLabel">Delete All Users</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form method="post" action="{{ url_for('admin_delete_all_users') }}">
              <div class="modal-body">
                <p class="text-danger">Are you sure you want to delete all users (except yourself)?</p>
                <p>This action cannot be undone. All associated data will also be deleted.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete All Users</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Employee ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Is Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in all_users %}
            <tr>
              <td>{{ user.employee_id }}</td>
              <td>{{ user.first_name }}</td>
              <td>{{ user.last_name }}</td>
              {% if user.is_admin %}
                <form method="post" action="{{ url_for('admin_edit_user', user_id=user.id) }}">
                  <td><input type="email" class="form-control form-control-sm" name="email" value="{{ user.email }}"></td>
                  <td>{{ user.phone_number or 'N/A' }}</td>
                  <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                  <td>
                    <button type="submit" class="btn btn-sm btn-success">Save</button>
                  </td>
                </form>
              {% else %}
                <td>{{ user.email }}</td>
                <td>{{ user.phone_number or 'N/A' }}</td>
                <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
                <td>
                  <div class="d-flex">
                    <button type="button" class="btn btn-sm btn-warning" data-toggle="modal" data-target="#resetPasswordModal{{ user.id }}">
                      Reset Password
                    </button>
                    <button type="button" class="btn btn-sm btn-danger ml-2" data-toggle="modal" data-target="#deleteUserModal{{ user.id }}">
                      Delete
                    </button>
                  </div>
                  <!-- Reset Password Modal and Delete User Modal remain unchanged for non-admins -->
                </td>
              {% endif %}
              <!-- Actions column handled above, remove duplicate buttons -->
            </tr>
          {% else %}
            <tr>
              <td colspan="6">No users found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
