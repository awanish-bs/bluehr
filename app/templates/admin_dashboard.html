{% extends "base.html" %}

{% block content %}
  <h2>Admin Dashboard</h2>

  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="finance-tab" data-toggle="tab" href="#finance" role="tab" aria-controls="finance" aria-selected="true">Finance</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="employment-history-tab" data-toggle="tab" href="#employment-history" role="tab" aria-controls="employment-history" aria-selected="false">Employment History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="admin-tab" data-toggle="tab" href="#admin" role="tab" aria-controls="admin" aria-selected="false">Admin</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="hr-tab" data-toggle="tab" href="#hr" role="tab" aria-controls="hr" aria-selected="false">HR</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="documents-tab" data-toggle="tab" href="#documents" role="tab" aria-controls="documents" aria-selected="false">Documents</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="others-tab" data-toggle="tab" href="#others" role="tab" aria-controls="others" aria-selected="false">Others</a>
    </li>
  </ul>

  <div class="tab-content mt-3" id="adminTabContent">
    <div class="tab-pane fade show active" id="finance" role="tabpanel" aria-labelledby="finance-tab">
      <!-- Employee Payslips Collapsible Section -->
      <div class="card mb-3">
        <div class="card-header bg-light font-weight-bold d-flex justify-content-between align-items-center" id="headingPayslips" style="cursor:pointer;" data-toggle="collapse" data-target="#collapsePayslips" aria-expanded="false" aria-controls="collapsePayslips">
          <span>Employee Payslips</span>
          <span class="collapse-icon" id="iconPayslips">&#9654;</span>
        </div>
        <div id="collapsePayslips" class="collapse" aria-labelledby="headingPayslips">
          <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if employee_payslips %}
              {% for employee, payslips in employee_payslips.items() %}
                <div class="mb-2">
                  <strong>{{ employee.first_name }} {{ employee.last_name }}</strong>
                  <ul class="list-group list-group-flush">
                    {% for payslip in payslips %}
                      <li class="list-group-item py-1 d-flex justify-content-between align-items-center">
                        <span>
                          <a href="{{ url_for('static', filename=payslip.file_path) }}" target="_blank">
                            Payslip - {{ payslip.upload_date.strftime('%Y-%m-%d') }}
                          </a>
                        </span>
                        <form method="post" action="{{ url_for('admin_delete_payslip', payslip_id=payslip.id) }}" style="display:inline;">
                          <button type="submit" class="btn btn-sm btn-danger ml-2">Delete</button>
                        </form>
                      </li>
                    {% else %}
                      <li class="list-group-item py-1 text-muted">No payslips found.</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            {% else %}
              <p>No employees or payslips found.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <!-- Upload Payslip Collapsible Section -->
      <div class="card">
        <div class="card-header bg-light font-weight-bold d-flex justify-content-between align-items-center" id="headingUpload" style="cursor:pointer;" data-toggle="collapse" data-target="#collapseUpload" aria-expanded="false" aria-controls="collapseUpload">
          <span>Upload Payslip</span>
          <span class="collapse-icon" id="iconUpload">&#9654;</span>
        </div>
        <div id="collapseUpload" class="collapse" aria-labelledby="headingUpload">
          <script>
            // Helper to toggle icon direction
            function toggleIcon(section, iconId) {
              var icon = document.getElementById(iconId);
              if (section.classList.contains('show')) {
                icon.innerHTML = '\u25BC'; // Down arrow
              } else {
                icon.innerHTML = '\u25B6'; // Right arrow
              }
            }
            document.addEventListener('DOMContentLoaded', function() {
              var payslipsSection = document.getElementById('collapsePayslips');
              var payslipsIcon = document.getElementById('iconPayslips');
              var uploadSection = document.getElementById('collapseUpload');
              var uploadIcon = document.getElementById('iconUpload');
              var createUserSection = document.getElementById('collapseCreateUser');
              var createUserIcon = document.getElementById('iconCreateUser');
              if (payslipsSection && payslipsIcon) {
                payslipsSection.addEventListener('show.bs.collapse', function() { toggleIcon(payslipsSection, 'iconPayslips'); });
                payslipsSection.addEventListener('hide.bs.collapse', function() { toggleIcon(payslipsSection, 'iconPayslips'); });
                toggleIcon(payslipsSection, 'iconPayslips');
              }
              if (uploadSection && uploadIcon) {
                uploadSection.addEventListener('show.bs.collapse', function() { toggleIcon(uploadSection, 'iconUpload'); });
                uploadSection.addEventListener('hide.bs.collapse', function() { toggleIcon(uploadSection, 'iconUpload'); });
                toggleIcon(uploadSection, 'iconUpload');
              }
              if (createUserSection && createUserIcon) {
                createUserSection.addEventListener('show.bs.collapse', function() { toggleIcon(createUserSection, 'iconCreateUser'); });
                createUserSection.addEventListener('hide.bs.collapse', function() { toggleIcon(createUserSection, 'iconCreateUser'); });
                toggleIcon(createUserSection, 'iconCreateUser');
              }
            });
          </script>
          <div class="card-body">
            <form method="post" action="{{ url_for('upload_payslip') }}" enctype="multipart/form-data">
              <div class="form-group">
                <label for="employee_id">Employee</label>
                <select class="form-control" id="employee_id" name="employee_id" required>
                  <option value="" disabled selected>Select an employee</option>
                  {% for employee in employees %}
                    <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group">
                <label for="month_year">Month and Year</label>
                <input type="month" class="form-control" id="month_year" name="month_year" required>
              </div>
              <div class="form-group">
                <label for="payslip">Payslip File</label>
                <input type="file" class="form-control-file" id="payslip" name="payslip" required>
              </div>
              <button type="submit" class="btn btn-primary">Upload</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="hr" role="tabpanel" aria-labelledby="hr-tab">
      <div class="card mb-4">
        <div class="card-header bg-light font-weight-bold">
          HR & Finance Documents (Admin Reference)
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('admin_upload_hr_finance_document') }}" enctype="multipart/form-data" class="mb-4">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="hr_doc_type">Type</label>
                <select class="form-control" id="hr_doc_type" name="doc_type" required>
                  <option value="HR">HR</option>
                  <option value="Finance">Finance</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="hr_comments">Comments</label>
                <input type="text" class="form-control" id="hr_comments" name="comments" maxlength="256" placeholder="Add comments (optional)">
              </div>
              <div class="form-group col-md-4">
                <label for="hr_document">Select File</label>
                <input type="file" class="form-control-file" id="hr_document" name="document" required>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Upload Document</button>
          </form>
          <h5>Uploaded Documents</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Filename</th>
                  <th>Type</th>
                  <th>Comments</th>
                  <th>Upload Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="hr-finance-doc-list">
                <!-- HR/Finance documents will be loaded here via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <script>
        // Load HR/Finance documents when HR tab is clicked
        document.getElementById('hr-tab').addEventListener('click', function() {
          setTimeout(loadHRFinanceDocuments, 100);
        });
        document.addEventListener('DOMContentLoaded', function() {
          if (window.location.hash === '#hr' || document.getElementById('hr-tab').classList.contains('active')) {
            loadHRFinanceDocuments();
          }
        });
        function loadHRFinanceDocuments() {
          fetch('/admin/hr_finance_documents')
            .then(response => response.json())
            .then(data => {
              const tbody = document.getElementById('hr-finance-doc-list');
              tbody.innerHTML = '';
              if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No documents uploaded yet.</td></tr>';
                return;
              }
              data.forEach(doc => {
                const row = `
                  <tr>
                    <td><a href="${doc.blob_url}" target="_blank">${doc.original_filename}</a></td>
                    <td>${doc.doc_type}</td>
                    <td>${doc.comments || ''}</td>
                    <td>${doc.upload_date}</td>
                    <td>
                      <form method="post" action="/admin/hr_finance_documents/delete/${doc.id}" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                      </form>
                    </td>
                  </tr>
                `;
                tbody.innerHTML += row;
              });
            })
            .catch(error => {
              const tbody = document.getElementById('hr-finance-doc-list');
              tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading documents.</td></tr>';
            });
        }
      </script>
    </div>
      <div class="tab-pane fade" id="employment-history" role="tabpanel" aria-labelledby="employment-history-tab">
        <div class="card">
          <div class="card-header bg-light font-weight-bold">
            <h5 class="mb-0">Employee Employment History</h5>
          </div>
          <div class="card-body">
            <p class="text-muted">View employment history submitted by employees.</p>
          
            <div id="adminEmploymentHistoryList">
              <div class="text-center py-3">
                <span class="spinner-border spinner-border-sm" role="status"></span>
                Loading employment history...
              </div>
            </div>
          </div>
        </div>
      
        <script>
          // Load employment history when tab is clicked
          document.getElementById('employment-history-tab').addEventListener('click', function() {
            loadAdminEmploymentHistory();
          });
        
          function loadAdminEmploymentHistory() {
            fetch('/admin/employment_history')
              .then(response => response.json())
              .then(data => {
                const container = document.getElementById('adminEmploymentHistoryList');
              
                if (data.length === 0) {
                  container.innerHTML = '<p class="text-muted">No employees found.</p>';
                  return;
                }
              
                let html = '<div class="accordion" id="employmentAccordion">';
              
                data.forEach(function(employee, index) {
                  const hasHistory = employee.employment_history && employee.employment_history.length > 0;
                  const historyCount = hasHistory ? employee.employment_history.length : 0;
                
                  html += `
                    <div class="card mb-2">
                      <div class="card-header p-2" id="heading${index}">
                        <h6 class="mb-0 d-flex justify-content-between align-items-center">
                          <button class="btn btn-link text-left collapsed" type="button" data-toggle="collapse" data-target="#collapse${index}" aria-expanded="false">
                            <strong>${employee.first_name} ${employee.last_name}</strong> 
                            <span class="text-muted ml-2">(${employee.employee_id})</span>
                          </button>
                          <span class="badge badge-${hasHistory ? 'primary' : 'secondary'}">${historyCount} record${historyCount !== 1 ? 's' : ''}</span>
                        </h6>
                      </div>
                      <div id="collapse${index}" class="collapse" aria-labelledby="heading${index}" data-parent="#employmentAccordion">
                        <div class="card-body">
                  `;
                
                  if (hasHistory) {
                    html += '<div class="table-responsive"><table class="table table-sm table-bordered">';
                    html += '<thead class="thead-light"><tr><th>Company</th><th>Designation</th><th>Start Date</th><th>End Date</th></tr></thead><tbody>';
                  
                    employee.employment_history.forEach(function(job) {
                      const endDate = job.end_date ? job.end_date : '<span class="badge badge-success">Present</span>';
                      html += `<tr><td>${job.company_name}</td><td>${job.designation}</td><td>${job.start_date}</td><td>${endDate}</td></tr>`;
                    });
                  
                    html += '</tbody></table></div>';
                  } else {
                    html += '<p class="text-muted mb-0">No employment history submitted by this employee.</p>';
                  }
                
                  html += '</div></div></div>';
                });
              
                html += '</div>';
                container.innerHTML = html;
              })
              .catch(error => {
                console.error('Error loading employment history:', error);
                document.getElementById('adminEmploymentHistoryList').innerHTML = '<p class="text-danger">Error loading employment history. Please try again.</p>';
              });
          }
        </script>
      </div>
      <div class="tab-pane fade" id="others" role="tabpanel" aria-labelledby="others-tab">
        <p>WIP</p>
      </div>
    <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
      <!-- Create User Section -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" id="headingCreateUser" style="cursor:pointer;" data-toggle="collapse" data-target="#collapseCreateUser" aria-expanded="false" aria-controls="collapseCreateUser">
          <h4 class="mb-0">Create New User</h4>
          <span class="collapse-icon text-white" id="iconCreateUser">&#9654;</span>
        </div>
        <div id="collapseCreateUser" class="collapse" aria-labelledby="headingCreateUser">
          <div class="card-body">
          <form method="post" action="{{ url_for('admin_create_user') }}" novalidate id="adminCreateUserForm">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="admin_first_name">First Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="admin_first_name" name="first_name" required>
                  <div class="invalid-feedback">First Name is required.</div>
                </div>
                <div class="form-group">
                  <label for="admin_last_name">Last Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="admin_last_name" name="last_name" required>
                  <div class="invalid-feedback">Last Name is required.</div>
                </div>
                <div class="form-group">
                  <label for="admin_employee_id">Employee ID <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="admin_employee_id" name="employee_id" required>
                  <div class="invalid-feedback">Employee ID is required and must be numeric.</div>
                </div>
                <div class="form-group">
                  <label for="admin_email">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="admin_email" name="email" required>
                  <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>
                <div class="form-group">
                  <label for="admin_phone_number">Phone Number</label>
                  <input type="tel" class="form-control" id="admin_phone_number" name="phone_number">
                  <div class="invalid-feedback">Phone number must be exactly 10 digits.</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="admin_aadhar_number">Aadhar Number</label>
                  <input type="text" class="form-control" id="admin_aadhar_number" name="aadhar_number">
                  <div class="invalid-feedback">Aadhar must be exactly 12 digits.</div>
                </div>
                <div class="form-group">
                  <label for="admin_pan_number">PAN Number</label>
                  <input type="text" class="form-control" id="admin_pan_number" name="pan_number">
                  <div class="invalid-feedback">PAN must be alphanumeric and 10 characters long.</div>
                </div>
                <div class="form-group">
                  <label for="admin_bank_account_number">Bank Account Number</label>
                  <input type="text" class="form-control" id="admin_bank_account_number" name="bank_account_number">
                  <div class="invalid-feedback">Bank account number must be numeric.</div>
                </div>
                <div class="form-group">
                  <label for="admin_password">Password <span class="text-danger">*</span></label>
                  <input type="password" class="form-control" id="admin_password" name="password" required>
                  <div class="invalid-feedback">Password is required.</div>
                </div>
                <div class="form-check">
                  <input type="checkbox" class="form-check-input" id="admin_is_admin" name="is_admin">
                  <label class="form-check-label" for="admin_is_admin">Is Admin</label>
                </div>
              </div>
            </div>
            <button type="submit" class="btn btn-success">Create User</button>
          </form>
        </div>
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All Users</h3>
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteAllUsersModal">
          Delete All Users
        </button>
      </div>

      <!-- Delete All Users Modal -->
      <div class="modal fade" id="deleteAllUsersModal" tabindex="-1" role="dialog" aria-labelledby="deleteAllUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteAllUsersModalLabel">Delete All Users</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <form method="post" action="{{ url_for('admin_delete_all_users') }}">
              <div class="modal-body">
                <p class="text-danger">Are you sure you want to delete all users (except yourself)?</p>
                <p>This action cannot be undone. All associated data will also be deleted.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Delete All Users</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Employee ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Is Admin</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in all_users %}
            <tr>
              <td>{{ user.employee_id }}</td>
              <td>{{ user.first_name }}</td>
              <td>{{ user.last_name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.phone_number or 'N/A' }}</td>
              <td>{{ 'Yes' if user.is_admin else 'No' }}</td>
              <td>
                {% if not user.is_admin %}
                <div class="d-flex">
                  <button type="button" class="btn btn-sm btn-warning" data-toggle="modal" data-target="#resetPasswordModal{{ user.id }}">
                    Reset Password
                  </button>
                  <button type="button" class="btn btn-sm btn-danger ml-2" data-toggle="modal" data-target="#deleteUserModal{{ user.id }}">
                    Delete
                  </button>
                </div>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            
            {% if not user.is_admin %}
            <!-- Reset Password Modal -->
            <div class="modal fade" id="resetPasswordModal{{ user.id }}" tabindex="-1" role="dialog" aria-labelledby="resetPasswordModalLabel{{ user.id }}" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel{{ user.id }}">Reset Password for {{ user.first_name }} {{ user.last_name }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <form method="post" action="{{ url_for('admin_reset_password', user_id=user.id) }}">
                    <div class="modal-body">
                      <div class="form-group">
                        <label for="new_password{{ user.id }}">New Password</label>
                        <input type="password" class="form-control" id="new_password{{ user.id }}" name="new_password" required>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Reset Password</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Delete User Modal -->
            <div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel{{ user.id }}" aria-hidden="true">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="deleteUserModalLabel{{ user.id }}">Delete User</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <form method="post" action="{{ url_for('admin_delete_user', user_id=user.id) }}">
                    <div class="modal-body">
                      <p class="text-danger">Are you sure you want to delete <strong>{{ user.first_name }} {{ user.last_name }}</strong>?</p>
                      <p>This action cannot be undone. All associated data will also be deleted.</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger">Delete User</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            {% endif %}
          {% else %}
            <tr>
              <td colspan="7">No users found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- End of Admin Tab -->
    
    <!-- Start of Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
      <div class="card">
        <div class="card-header bg-light font-weight-bold">
          <h5 class="mb-0">Document Management</h5>
        </div>
        <div class="card-body">
          <!-- Document Upload Form -->
          <div class="card mb-4">
            <div class="card-header">
              Upload New Document
            </div>
            <div class="card-body">
              <form method="post" action="{{ url_for('admin_upload_document') }}" enctype="multipart/form-data">
                <div class="form-group">
                  <label for="document">Select File</label>
                  <input type="file" class="form-control-file" id="document" name="document" required>
                </div>
                <div class="form-group">
                  <label for="target_type">Target Audience</label>
                  <select class="form-control" id="target_type" name="target_type">
                    <option value="all">All Employees (Common Document)</option>
                    <option value="specific">Specific Employee</option>
                  </select>
                </div>
                <div class="form-group" id="employee-select-group" style="display: none;">
                  <label for="employee_id">Select Employee</label>
                  <select class="form-control" id="employee_id" name="employee_id">
                    <option value="" disabled selected>Select an employee</option>
                    {% for emp in all_users %}
                      {% if not emp.is_admin %}
                        <option value="{{ emp.id }}">{{ emp.first_name }} {{ emp.last_name }} ({{ emp.employee_id }})</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
              </form>
            </div>
          </div>

          <!-- Uploaded Documents List -->
          <h5>Uploaded Documents</h5>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Filename</th>
                  <th>Target</th>
                  <th>Type</th>
                  <th>Upload Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="document-list-body">
                <!-- Documents will be loaded here via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Activate tab from URL anchor on page load
    document.addEventListener('DOMContentLoaded', function() {
      var hash = window.location.hash;
      if (hash) {
        var tabLink = document.querySelector('a.nav-link[href="' + hash + '"]');
        if (tabLink) {
          $(tabLink).tab('show');
        }
      }
    });
    // Show/hide employee dropdown based on target type
    document.getElementById('target_type').addEventListener('change', function() {
      const employeeSelect = document.getElementById('employee-select-group');
      if (this.value === 'specific') {
        employeeSelect.style.display = 'block';
      } else {
        employeeSelect.style.display = 'none';
      }
    });

    // Load documents when tab is clicked
    document.getElementById('documents-tab').addEventListener('click', function() {
      setTimeout(loadAdminDocuments, 100);
    });

    // Also load documents on page load if Documents tab is active or if redirected from upload
    document.addEventListener('DOMContentLoaded', function() {
      // Check if the URL has the documents anchor or if the Documents tab should be active
      if (window.location.hash === '#documents' || document.getElementById('documents-tab').classList.contains('active')) {
        loadAdminDocuments();
      }
    });

    function loadAdminDocuments() {
      fetch('/admin/documents')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('document-list-body');
          tbody.innerHTML = '';
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No documents uploaded yet.</td></tr>';
            return;
          }
          data.forEach(doc => {
            const row = `
              <tr>
                <td><a href="/documents/download/${doc.id}" target="_blank">${doc.original_filename}</a></td>
                <td>${doc.target}</td>
                <td><span class="badge badge-secondary">${doc.file_type}</span></td>
                <td>${doc.upload_date}</td>
                <td>
                  <form method="post" action="/admin/documents/delete/${doc.id}" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        })
        .catch(error => {
          console.error('Error loading documents:', error);
          const tbody = document.getElementById('document-list-body');
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading documents.</td></tr>';
        });
    }

    // Admin Create User Form Validation
    const adminCreateUserForm = document.getElementById('adminCreateUserForm');
    if (adminCreateUserForm) {
      const adminValidations = {
        first_name: { required: true, message: 'First Name is required.' },
        last_name: { required: true, message: 'Last Name is required.' },
        employee_id: { required: true, pattern: /^[0-9]+$/, message: 'Employee ID is required and must be numeric.' },
        email: { required: true, pattern: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/, message: 'Please enter a valid email address.' },
        phone_number: { required: false, pattern: /^[0-9]{10}$/, message: 'Phone number must be exactly 10 digits.' },
        aadhar_number: { required: false, pattern: /^[0-9]{12}$/, message: 'Aadhar must be exactly 12 digits.' },
        pan_number: { required: false, pattern: /^[A-Za-z0-9]{10}$/, message: 'PAN must be alphanumeric and 10 characters long.' },
        bank_account_number: { required: false, pattern: /^[0-9]+$/, message: 'Bank account number must be numeric.' },
        password: { required: true, message: 'Password is required.' }
      };

      function validateAdminField(field) {
        const value = field.value.trim();
        const rules = adminValidations[field.name];
        if (!rules) return true;

        const feedback = field.nextElementSibling;
        
        // Check required
        if (rules.required && !value) {
          field.classList.add('is-invalid');
          field.classList.remove('is-valid');
          if (feedback) feedback.textContent = rules.message;
          return false;
        }
        
        // Check pattern (only if value is not empty)
        if (value && rules.pattern && !rules.pattern.test(value)) {
          field.classList.add('is-invalid');
          field.classList.remove('is-valid');
          if (feedback) feedback.textContent = rules.message;
          return false;
        }
        
        field.classList.remove('is-invalid');
        if (value) field.classList.add('is-valid');
        return true;
      }

      // Validate on blur for admin form fields
      Object.keys(adminValidations).forEach(function(fieldName) {
        const field = document.getElementById('admin_' + fieldName);
        if (field) {
          field.addEventListener('blur', function() {
            validateAdminField(this);
          });
          field.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
              validateAdminField(this);
            }
          });
        }
      });

      // Validate on submit for admin form
      adminCreateUserForm.addEventListener('submit', function(e) {
        let isValid = true;
        Object.keys(adminValidations).forEach(function(fieldName) {
          const field = document.getElementById('admin_' + fieldName);
          if (field && !validateAdminField(field)) {
            isValid = false;
          }
        });
        
        if (!isValid) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    }
  </script>
    <div class="tab-pane fade" id="others" role="tabpanel" aria-labelledby="others-tab">
      <p>WIP</p>
    </div>
  </div>
{% endblock %}
